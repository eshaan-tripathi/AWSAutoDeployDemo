name: Deploy AWS Lambda

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        if: hashFiles('lambda/package.json') != ''
        run: |
          cd lambda
          npm install

      - name: Lambda Syntax Check
        run: |
          cd lambda
          npx eslint . --ext .js

      - name: Run Lambda Tests
        id: run_tests
        if: hashFiles('lambda/tests/**') != ''
        continue-on-error: true
        run: |
          set -e
          node lambda/tests/test_lambda.js

      - name: Detect Changed Services
        id: detect

        run: |
          echo "services=[]" >> $GITHUB_ENV
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          else
            changed_files=$(find lambda -type f)
          fi
          services=()
          if echo "$changed_files" | grep -q "lambda/"; then
            services+=("lambda")
          fi
          echo "services=${services[*]}" >> $GITHUB_ENV
          echo "Detected services: ${services[*]}"

      - name: Zip Lambda code
        run: |
          cd lambda
          zip -r ../terraform/lambda_function_payload.zip . -x "tests/*" "node_modules/*"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Init
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: terraform init -reconfigure -input=false

      - name: Import existing Lambda and S3 (if they exist)
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          set -e
          FUNCTION_NAME="my-demo-lam-e"
          BUCKET_NAME="eshaan-terra-backend"

          # Import Lambda
          if aws lambda get-function --function-name "$FUNCTION_NAME" >/dev/null 2>&1; then
            echo "Lambda '$FUNCTION_NAME' exists — importing into Terraform state..."
            if ! terraform state list | grep -q "aws_lambda_function.demo_lambda"; then
              terraform import aws_lambda_function.demo_lambda "$FUNCTION_NAME"
            fi
          else
            echo "Lambda '$FUNCTION_NAME' does not exist — Terraform will create it."
          fi

          # Import S3 bucket
          if aws s3api head-bucket --bucket "$BUCKET_NAME" >/dev/null 2>&1; then
            echo "S3 bucket '$BUCKET_NAME' exists — importing into Terraform state..."
            if ! terraform state list | grep -q "aws_s3_bucket.demo_s3"; then
              terraform import aws_s3_bucket.demo_s3 "$BUCKET_NAME"
            fi
          else
            echo "S3 bucket '$BUCKET_NAME' does not exist — Terraform will create it."
          fi

      - name: Capture current Lambda alias version
        id: capture_version
        run: |
          FUNCTION_NAME="my-demo-lam-e"
          ALIAS_NAME="prod"
          if aws lambda get-alias --function-name "$FUNCTION_NAME" --name "$ALIAS_NAME" >/dev/null 2>&1; then
            CURRENT_VERSION=$(aws lambda get-alias --function-name "$FUNCTION_NAME" --name "$ALIAS_NAME" --query 'FunctionVersion' --output text)
            echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          else
            echo "CURRENT_VERSION=" >> $GITHUB_ENV
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      - name: Terraform Apply (update only)
        id: apply
        working-directory: terraform
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: terraform apply -auto-approve -input=false

      - name: Run Load Test with Artillery
        run: |
          # Fetch Lambda ARN dynamically from Terraform outputs
          LAMBDA_ARN=$(terraform output -raw lambda_function_arn)

          # Install Artillery
          npm install -g artillery

          # Create a simple load test config
          echo "config:
            target: \"aws-lambda://${LAMBDA_ARN}\"
            phases:
              - duration: 60
                arrivalRate: 5
          " > load-test.yaml

          # Run the test
          artillery run load-test.yaml
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      
      - name: Publish new Lambda version
        if: success()
        run: |
          FUNCTION_NAME="my-demo-lam-e"
          VERSION=$(aws lambda publish-version --function-name "$FUNCTION_NAME" --query 'Version' --output text)
          echo "Published version: $VERSION"
          echo "LATEST_VERSION=$VERSION" >> $GITHUB_ENV
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1


      - name: Create or Update Lambda alias
        if: success()
        run: |
          FUNCTION_NAME="my-demo-lam-e"
          ALIAS_NAME="prod"
          VERSION="$LATEST_VERSION"
          echo "Updating alias '$ALIAS_NAME' to version $VERSION"

          if aws lambda get-alias --function-name "$FUNCTION_NAME" --name "$ALIAS_NAME" >/dev/null 2>&1; then
            aws lambda update-alias \
              --function-name "$FUNCTION_NAME" \
              --name "$ALIAS_NAME" \
              --function-version "$VERSION"
          else
            aws lambda create-alias \
              --function-name "$FUNCTION_NAME" \
              --name "$ALIAS_NAME" \
              --function-version "$VERSION" \
              --description "Production alias"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
          

      - name: Rollback Lambda alias if apply fails
        if: failure()
        run: |
          if [ -n "$CURRENT_VERSION" ]; then
            echo "Terraform apply failed. Rolling back Lambda alias..."
            aws lambda update-alias \
              --function-name my-demo-lam-e \
              --name prod \
              --function-version "$CURRENT_VERSION"
          else
            echo "No previous alias version found. Skipping rollback."
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      - name: SNS Notification with Logs
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
          SNS_TOPIC_ARN: arn:aws:sns:us-east-1:612572392212:LambdaDeployNotifications-e
        run: |
          LOGS=$(tail -n 100 $GITHUB_WORKSPACE/_temp/_runner_file_commands/set_env_* 2>/dev/null || echo "No logs available")
          if [ "${{ job.status }}" == "success" ] && [ "${{ steps.run_tests.outcome }}" == "success" ]; then
            MESSAGE="Lambda deployment succeeded! Branch: ${{ github.ref }}, Commit: ${{ github.sha }}"
          else
            MESSAGE="Lambda deployment failed! Branch: ${{ github.ref }}, Commit: ${{ github.sha }}\n\nLast 100 lines of logs:\n$LOGS"
          fi
          aws sns publish \
            --topic-arn "$SNS_TOPIC_ARN" \
            --message "$MESSAGE" \
            --region $AWS_DEFAULT_REGION
